//! GraphQL schema: QueryRoot and MutationRoot are derived from the entity list
//! via `schema_roots!`. Add a new entity in the entities module and in the
//! list below; Queries/Mutations/CustomOperations are generated by the macro.

use std::sync::Arc;

use async_graphql::Schema;
use librarian_macros::schema_roots;

use crate::db::Database;
use crate::services::graphql::entities::*;
use crate::services::graphql::mutations::{AuthMutations, FilesystemMutations};
use crate::services::graphql::queries::FilesystemQueries;
use crate::services::graphql::subscriptions::filesystem::FilesystemChangeBroker;
use crate::services::graphql::subscriptions::FilesystemSubscriptions;
use crate::services::ServicesManager;

schema_roots! {
    query_custom_ops: [User, Torrent],
    entities: [
        Library,
        Movie,
        Show,
        Episode,
        MediaFile,
        Artist,
        Album,
        Track,
        Audiobook,
        Chapter,
        Torrent,
        TorrentFile,
        RssFeed,
        RssFeedItem,
        PendingFileMatch,
        IndexerConfig,
        IndexerSetting,
        IndexerSearchCache,
        User,
        InviteToken,
        RefreshToken,
        AppSetting,
        AppLog,
        VideoStream,
        AudioStream,
        Subtitle,
        MediaChapter,
        PlaybackSession,
        PlaybackProgress,
        CastDevice,
        CastSession,
        CastSetting,
        UsenetServer,
        UsenetDownload,
        ScheduleCache,
        ScheduleSyncState,
        NamingPattern,
        SourcePriorityRule,
        Notification,
        ArtworkCache,
        TorznabCategory,
    ],
    extra_query_types: [FilesystemQueries],
    extra_mutation_types: [AuthMutations, FilesystemMutations, TorrentClientMutations],
    extra_subscription_types: [FilesystemSubscriptions],
}

/// The GraphQL schema type
pub type LibrarianSchema = Schema<QueryRoot, MutationRoot, SubscriptionRoot>;

/// Build the GraphQL schema with all resolvers.
/// Pass the [ServicesManager] so resolvers can obtain the torrent service etc.
pub fn build_schema<E>(db: Database, auth_service: E, services: Arc<ServicesManager>) -> LibrarianSchema
where
    E: Send + Sync + Clone + 'static,
{
    Schema::build(
        QueryRoot::default(),
        MutationRoot::default(),
        SubscriptionRoot::default(),
    )
    .data(db)
    .data(auth_service)
    .data(services)
    .data(FilesystemChangeBroker::new(64))
    .finish()
}
